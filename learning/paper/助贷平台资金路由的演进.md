## 背景
还呗最初是一款信用卡账单分期 App，服务广大信用卡持卡人，帮用户解决信用卡难题。而后还呗衍生出了多种产品形态，如面向年轻人提供账单分期和商品分期等多种服务。用户可在购物、消费、还款场景下，享受更灵活、更便捷、更高效的分期生活服务。

虽然产品形态多样，但本质上还呗为用户提供的是小额贷款服务。由于还呗并无自有资金，是一个助贷平台，并且在还呗几年的努力下，与还呗合作的资金方很多，作为借款人和资金方的中介，当用户在还呗平台发起借款请求时，如何为用户推荐最合适的资金方，是还呗的一项最基本也是最重要的能力。

> 备注：「助贷业务」是指助贷机构利用自身掌握的获客、风控及贷后管理优势，向资金方(包括持牌金融机构、类金融机构)推荐借款人，经资金方风控终审后，完成发放贷款，并获取相关服务费的业务。

[业务架构简图]()

用户 -> 还呗App -> 借款引擎 -> 资金方

## 用户借款流程
用户打开还呗App后，选择使用的产品，比如选择了产品「还信用卡」。

[还呗主页面]()

之后打开借款方案选择页面，用户需要选择借款金额和还款的分期数。

[借款第一步]()

选择之后，系统会自动基于金额和期数，匹配最合适的资金方，并算出用户的还款方案（比如每一期要还多少钱，每一期还款的本金、利息是多少等）

[借款试算页]()

用户确认过之后，就提交借款成功了。

[借款提交成功页]()

之后，系统会基于用户选择的金额、期数，以及系统匹配到的资金方，使用该资金方的资金完成对用户的放款。

[完整时序图精简版]()
用户 -> 还呗 -> 借款引擎 -> 资金方：输入借款金额、分期；匹配资金方；计算还款方案
- <- : 返回还款方案
- -> : 确认借款信息并提交
- <- : 借款提交成功啦；后续放款处理

因为是精简版的流程图，所以看起来很简单，但是其中有一个要点是值得探讨的：与还呗合作的资金方很多，但是系统是怎么选择出最适合当前用户的资金方的呢？

### 方案一：轮询方式

[借款引擎 -> 资金方1，资金方2，资金方3]()

第一次匹配时选择资金方1，第二次匹配时选择资金方2，第三次匹配时选择资金方3，第四次匹配时重新选择资金方1 ......

缺点：每个资金方支持的金额和分期并不一样；资金方每天放款的金额是有限制的，金额放完后就不能再放款了；有些资金方只支持40岁以下的用户借款，而有些资金方则不作限制......

由于每个资金方的放款规则都不同，且会根据用户的借款意愿、用户的个人信息、每日放款情况等等综合判断并匹配最合适的资金方，所以不能采用轮询的方式决定资金方。

### 方案二：代码实现资金方匹配策略

比如写如下伪代码：

```java
if (资金没放完(资金方1)) {
    if (年龄 <= 40) {
        return "资金方1";
    }
}
if (资金没放完(资金方2)) {
    if (年龄 <= 40) {
        if (用户借款金额 < 1000) {
            if (用户选择分期 in [3, 6, 12]){
                return "资金方2";
            }
         }
    }
}
if (资金没放完(资金方3)) {
... ...
```

这样写可以满足需求，甚至代码设计的比较好的情况下，能够有较高的可读性、可扩展性等。

这样做有一个很大的问题：当商务同事隔几天要求接入个新的资金方，并需要根据需求开发复杂的匹配规则；当商务同事隔几天就觉得之前某个资金方的规则不满意，想要更改匹配规则时，这时开发工作变成了纯粹的需求翻译工作，体现不出创造性，且在此处始终需要维持明显的开发成本。

## 方案三：借款路由 1.0
由于资方的匹配规则会经常性的变化，导致始终需要维持明显的开发成本，那么解决方案就呼之欲出了：将资方的匹配规则及相关复杂逻辑从业务代码中剥离出去，转由独立的决策模块完成，决策模块可以提供友好的配置页面，方便业务同事独立完成配置工作。

### 方案设计

每当借款引擎收到匹配资金方的任务时，借款引擎会准备足够的参数，并将这些参数输入决策路由，决策路由经过计算后会吐出一个值，该值即代表某一个资金方。

每当业务方需要变更匹配规则时，只需要根据借款引擎提供的丰富的参数，独立在决策路由的配置页面完成规则的配置工作即可。

[决策路由示例]()

决策路由基本用法

> 决策路由配置后，会形成一颗决策树，决策树上有多个决策节点，每个决策节点上均维护有独立的匹配规则。每次决策执行时，均会对决策树进行遍历，采用深度优先遍历（DFS）的思想，对遍历过程中访问的每一个决策节点执行匹配规则，匹配失败时会跳过该决策节点，匹配成功时会检查是否有决策子树，有子树时继续访问子树，无子树时直接返回当前决策节点的取值。

当然，有时候，借款引擎默认给出的参数可能并不够，需要补充一些参数，比如：用户使用的客户端版本、用户的手机系统类型、用户使用的借款产品类型等。当然这也没有问题，增加通用的输入参数与变更匹配规则相比，开发量小了很多。

用户 -> 还呗 -> 借款引擎 -> 决策路由：输入借款金额、分期；匹配资金方


### 总结
采用决策路由有以下特点：
1. 资金方匹配规则由业务同事独立设计与实现，对于开发同事和业务系统均无感知。
2. 将基本不变的业务流程代码与经常变动的资金方匹配逻辑剥离，两者独立维护，可保证通用业务流程的整体稳定性。
3. 明显减轻业务系统的开发压力，但增加了业务同事配置的工作量。

### 问题
该方案设计出来后，效果很好，稳定工作了一年，而后开始逐步暴露出问题了：

1. 资金方规则匹配的复杂逻辑完全从代码中抽离了出来，开发同事的工作量明显减少，但随着资金方越来越多，规则越来越复杂，决策路由的配置也越来越复杂，配置经常出错，每天都有相关的问题产生且需要排查，总之决策路由的维护成本越来越高。
2. 每个资金方支持的分期范围和金额范围都有可能不同，且针对不同的用户，每个资金方是否可以支持也都有所不同。用户借款时看到的是同一套可供选择的金额范围和分期范围方案，这套方案虽然经过了精心的人工设计，但仍然难以满足所有用户的需求，容易发生这样的问题：用户选择了某个不支持的金额和分期，导致无法匹配到可用的资方，从而无法成功提交借款请求。

针对以上问题，我们提出了新的设计方案

## 借款路由 2.0

### 剥离及使用资金方的静态配置

决策路由维护的规则过于繁杂，其中有些配置具有共性，虽然不同资金方匹配规则的具体取值不同，但是匹配的逻辑是一致的，没必要在决策路由中一遍一遍重复配置同一类规则，这类规则完全可以剥离出来由代码实现，从而明显减轻决策路由的负担。

> 使用资金配置中心，使用统一的维护页面，单独配置各个资金方共有的静态配置。这些配置可以独立在代码中维护匹配规则，从而减轻决策路由的负担。如各个资金方支持的分期范围和金额范围、资金方支持的借款优惠券类型等。

[资金配置中心]()

### 实现用户可选择借款方案的动态生成

对决策路由整体进行重构，将决策路由整体上分为两个决策模块：准入模块和策略模块。用户要发起借款时，先过准入模块，得到一个资金方列表，须保证该列表中的资金方，当前用户均可用于借款。将这些资金方支持的借款金额范围、支持的借款分期范围等取并集，即可得到用户可选择的借款金额、分期范围。根据不同的用户特征可生成最合适的可选择的借款方案。经过以上操作，可保证该借款方案用户任意选择后，均能匹配到至少一个资金方，大大增加了用户的借款成功率。

### 将单个决策路由拆为两个决策模块
对决策路由整体进行重构，将决策路由整体上分为两个决策模块：准入模块和策略模块。准入模块主要用于生成可借款的资金方列表，进而生成用户可选择的借款方案；用户选择借款方案后，会经过策略模块，用于从刚刚生成的资金方列表中匹配最合适的资金方。两个决策模块职责分明，单个模块相比于原先的决策路由复杂性均大大减小。

### 基于业务流引擎重构整个决策路由
......

[借款流程简图]()


## 借款路由 3.0

### 问题
根据前面的讨论可以发现，对借款引擎来说，随着时间的推移，借款引擎需要开发的路由输入参数越来越多，我们逐渐发现，这些参数可以分为两类：

第一类是借款流程必知的参数，如：本次用户借款的金额、期数、借款银行卡、还款银行卡等，这些参数借款引擎本身就需要知道，甚至有些参数可能就只有借款引擎知道，所以借款引擎开发这些输入参数无可厚非；

第二类需要借款引擎耦合其他业务系统并计算得到，如：用户是否绑定了某个银行的借记卡（需要耦合卡系统）、用户在某个特定的资金方是否已授信（需要耦合资金系统）、用户是否有借款还未还款完毕（需要耦合订单系统）、用户的真实姓名及注册手机号（需要耦合用户信息系统）。
